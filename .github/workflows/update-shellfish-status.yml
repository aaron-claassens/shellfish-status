name: Update Shellfish Status JSON

on:
  workflow_dispatch:
  schedule:
    - cron: '*/15 * * * *'

jobs:
  build-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install scraping dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Scrape NSW Shellfish Status and write status.json
        run: |
          python - << 'PYCODE'
          import requests
          from bs4 import BeautifulSoup
          import json
          import os
          import datetime

          URL = "https://www.foodauthority.nsw.gov.au/industry/shellfish/status"
          resp = requests.get(URL, timeout=15)
          resp.raise_for_status()
          soup = BeautifulSoup(resp.text, "html.parser")

          status_divs = soup.select(".sqap-card__status .field__item")
          open_count = sum(1 for d in status_divs if d.text.strip().lower() == "open")
          closed_count = sum(1 for d in status_divs if d.text.strip().lower() == "closed")

          data = {
              "open": open_count,
              "closed": closed_count,
              "last_updated": datetime.datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")
          }
          with open("status.json", "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)

          print(f"Wrote status.json: open={open_count}, closed={closed_count}")
          PYCODE

      - name: Commit status.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json
          if ! git diff --cached --quiet; then
            git commit -m "Automated update of shellfish status (every 15 min)"
            git push
          else
            echo "No changes to status.json; skipping commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
